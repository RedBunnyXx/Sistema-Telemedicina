<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Nueva Cita - MediConnect</title>

    <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/Estilos/inicio.css}">
    <link rel="stylesheet" th:href="@{/Estilos/agendamiento.css}">
    
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>

    <div class="dashboard-wrapper d-flex">
        <div th:replace="~{fragments/sidebar :: sidebar}"></div>

        <main class="main-content flex-grow-1 p-4 p-md-5">
            <div class="main-container">
                
                <header class="page-header">
                    <h1>Agendar Nueva Cita</h1>
                    <p>Sigue los pasos para programar tu teleconsulta</p>
                </header>

                <div class="stepper-container">
                    <div class="step active" id="progress-step-1">
                        <div class="step-circle">1</div>
                        <span>Seleccionar Doctor</span>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" id="progress-step-2">
                        <div class="step-circle">2</div>
                        <span>Elegir Horario</span>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" id="progress-step-3">
                        <div class="step-circle">3</div>
                        <span>Confirmar Cita</span>
                    </div>
                </div>

                <div class="steps-content">

                    <div id="step-1" class="step-section active-section">
                        <div class="section-title">
                            <h2>Selecciona un Especialista</h2>
                            <p>Busca y selecciona el médico con quien deseas agendar tu teleconsulta</p>
                        </div>

                        <div class="filters-bar">
                            <div class="search-input">
                                <i class="fa-solid fa-magnifying-glass"></i>
                                <input type="text" placeholder="Buscar por nombre o especialidad...">
                            </div>
                            <div class="specialty-select">
                                <select id="specialtyFilter" onchange="filterDoctors()">
                                    <option value="all">Todas las especialidades</option>
                                    <option value="Medicina General">Medicina General</option>
                                    <option value="Cardiología">Cardiología</option>
                                    <option value="Dermatología">Dermatología</option>
                                    <option value="Endocrinología">Endocrinología</option>
                                    <option value="Gastroenterología">Gastroenterología</option>
                                    <option value="Neurología">Neurología</option>
                                    <option value="Pediatría">Pediatría</option>
                                    <option value="Psiquiatría">Psiquiatría</option>
                                </select>
                            </div>
                        </div>

                        <div class="doctors-list" id="doctorsListContainer">
                            <div class="doctor-card"
                                 th:each="medico : ${medicos}"
                                 th:data-id="${medico.id}"
                                 th:data-name="${medico.persona.nombres + ' ' + medico.persona.apellidos}"
                                 th:data-specialty="${medico.especialidad.nombre}"
                                 th:data-cmp="${medico.cmp}"
                                 th:data-costo="${medico.especialidad.costo}" 
                                 th:onclick="|selectDoctorCard(this)|">
                                <div class="doctor-info-left">
                                    <div class="avatar-placeholder">
                                        <img th:if="${medico.persona.fotoPerfil} != null"
                                             th:src="@{'/uploads/perfiles/' + ${medico.persona.fotoPerfil}}"
                                             alt="Foto Médico"
                                             style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                                        <span th:if="${medico.persona.fotoPerfil} == null"
                                              th:text="${#strings.substring((medico.persona.nombres + ' ' + medico.persona.apellidos), 0, 1)}">D</span>
                                    </div>
                                    <div class="doc-details">
                                        <h3 th:text="${medico.persona.nombres + ' ' + medico.persona.apellidos}">Nombre Médico</h3>
                                        <span class="specialty" th:text="${medico.especialidad.nombre}">Especialidad</span>
                                        <div class="doc-stats">
                                            <i class="fa-solid fa-id-badge"></i>
                                            <strong>CMP: </strong>
                                            <span th:text="${medico.cmp}">000000</span>
                                        </div>
                                        <div style="margin-top:5px; font-size:12px; color:#666">Precio Consulta: S/ <span th:text="${medico.especialidad.costo}">0.00</span></div>
                                    </div>
                                </div>
                                <span class="badge-status">Disponible</span>
                            </div>
                        </div>

                        <div class="step-footer">
                            <button class="btn-secondary">Cancelar</button>
                            <button class="btn-primary" id="btn-next-1" disabled onclick="nextStep(2)">Siguiente <i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>

                    <div id="step-2" class="step-section">
                        <div class="section-title">
                            <h2>Elige Fecha y Hora</h2>
                            <p>Selecciona el día y horario que mejor se adapte a ti</p>
                        </div>

                        <div class="datetime-layout">
                            <div class="calendar-container">
                                <h3>Selecciona una fecha</h3>
                                <div class="date-input-wrapper">
                                    <i class="fa-regular fa-calendar"></i>
                                    <input type="date" id="datePicker" class="form-control">
                                </div>
                                <div class="selected-date-display" id="selectedDateDisplay">
                                    Fecha seleccionada: <strong>Selecciona una fecha</strong>
                                </div>
                            </div>

                            <div class="time-slots-container">
                                <h3><i class="fa-regular fa-clock"></i> Horarios Disponibles</h3>
                                <p class="doctor-time-ref">
                                    Horarios de <span id="doctorNameRef">Dr. Seleccionado</span> para el
                                    <span id="doctorDateRef">29 de noviembre</span>
                                </p>
                                
                                <div class="time-group">
                                    <h4>Mañana</h4>
                                    <div class="slots-grid">
                                        <button class="time-slot" onclick="selectTime(this)">08:00</button>
                                        <button class="time-slot" onclick="selectTime(this)">09:00</button>
                                        <button class="time-slot" onclick="selectTime(this)">10:00</button>
                                        <button class="time-slot" onclick="selectTime(this)">11:00</button>
                                    </div>
                                </div>

                                <div class="time-group">
                                    <h4>Tarde</h4>
                                    <div class="slots-grid">
                                        <button class="time-slot selected-time" onclick="selectTime(this)">14:00</button>
                                        <button class="time-slot" onclick="selectTime(this)">15:00</button>
                                        <button class="time-slot" onclick="selectTime(this)">16:00</button>
                                    </div>
                                </div>

                                <div class="selected-time-display" id="selectedTimeDisplay">
                                    Hora seleccionada: <strong>14:00</strong>
                                </div>
                            </div>
                        </div>

                        <div class="step-footer">
                            <button class="btn-secondary" onclick="prevStep(1)"><i class="fa-solid fa-chevron-left"></i> Anterior</button>
                            <button class="btn-primary" id="btn-next-2" onclick="nextStep(3)">Siguiente <i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>

                    <div id="step-3" class="step-section">
                        <div class="section-title">
                            <h2>Confirma y Paga tu Cita</h2>
                            <p>Revisa los detalles y realiza el pago seguro</p>
                        </div>

                        <div class="confirmation-card">
                            <div class="confirm-icon">
                                <i class="fa-solid fa-credit-card"></i>
                            </div>
                            <h3>Resumen de la Cita</h3>
                            
                            <p style="font-size: 1.3rem; color: #0e82cd; font-weight: bold; margin: 15px 0;">
                                Total a Pagar: S/ <span id="displayPrecio">0.00</span>
                            </p>

                            <div class="summary-doctor">
                                <div class="avatar-circle" id="summaryAvatar">D</div>
                                <div class="doctor-details">
                                    <h4 id="summaryDoctorName">Dr. Nombre</h4>
                                    <span id="summarySpecialty">Especialidad</span>
                                </div>
                            </div>

                            <div class="summary-grid">
                                <div class="summary-item">
                                    <i class="fa-regular fa-calendar"></i>
                                    <div>
                                        <small>Fecha</small>
                                        <strong id="summaryDate">Fecha</strong>
                                    </div>
                                </div>
                                <div class="summary-item">
                                    <i class="fa-regular fa-clock"></i>
                                    <div>
                                        <small>Hora</small>
                                        <strong id="summaryTime">Hora</strong>
                                    </div>
                                </div>
                                <div class="summary-item full-width">
                                    <i class="fa-solid fa-video"></i>
                                    <div>
                                        <small>Tipo de consulta</small>
                                        <strong>Teleconsulta (Videollamada)</strong>
                                    </div>
                                </div>
                            </div>

                            <div style="background-color: #f8fbff; padding: 25px; border-radius: 12px; border: 1px solid #cce5ff; margin-top: 25px; text-align: left;">
                                <h5 style="margin-bottom: 15px; color: #333; font-size: 16px;"><i class="fa-solid fa-lock"></i> Pago Seguro con Tarjeta</h5>
                                <form id="payment-form">
                                    <div id="payment-element">
                                        </div>
                                    <div id="payment-message" style="color: #dc3545; margin-top: 10px; display: none; font-size: 14px;"></div>
                                </form>
                            </div>

                        </div>

                        <div class="step-footer">
                            <button class="btn-secondary" onclick="prevStep(2)">Volver</button>
                            <button class="btn-primary" id="btn-pay-confirm" onclick="procesarPagoYConfirmar()">
                                Pagar y Confirmar Cita
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <div id="successModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <div class="modal-icon">
                <i class="fa-solid fa-check"></i>
            </div>
            <h2>Cita Confirmada</h2>
            <p>Tu cita ha sido pagada y programada exitosamente</p>
            
            <div class="modal-summary">
                <div class="modal-item">
                    <i class="fa-regular fa-calendar"></i>
                    <div>
                        <small>Fecha y hora</small>
                        <strong id="modalDateTime">...</strong>
                    </div>
                </div>
                <div class="modal-item">
                    <i class="fa-solid fa-user-doctor"></i>
                    <div>
                        <small>Especialista</small>
                        <strong id="modalDoctorName">...</strong>
                    </div>
                </div>
            </div>

            <p class="email-notice">
                <i class="fa-regular fa-envelope"></i> Recibirás una confirmación por correo electrónico<br>
            </p>

            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModal()">Cerrar</button>
                <a class="btn-primary" th:href="@{/citas}">Ver Mis Citas</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/JavaScript/agendamiento.js}"></script>
    
</body>
</html>